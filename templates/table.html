{% extends "base.html" %}
{% block content %}

<h1>Registros</h1>

<!-- TOPO: filtros, ações, seleção de escritório -->
<div class="toolbar">

    <!-- Seleção do escritório -->
    <form method="GET" action="{{ url_for('table') }}" class="inline">
        <input type="hidden" name="page" value="1">

        <label>Escritório:
            <select name="office" onchange="this.form.submit()">
                <option value="ALL" {% if office == 'ALL' %}selected{% endif %}>TODOS</option>
                {% for o in offices %}
                    <option value="{{ o.key }}" {% if office == o.key %}selected{% endif %}>{{ o.display }}</option>
                {% endfor %}
            </select>
        </label>
    </form>

    <!-- Filtro de busca -->
    <form method="GET" action="{{ url_for('table') }}" class="inline">
        <input type="hidden" name="office" value="{{ office }}">

        <label>Buscar por:
            <select name="filtro">
                <option value="">--</option>
                <option value="nome" {% if filtro=='nome' %}selected{% endif %}>Nome</option>
                <option value="cpf" {% if filtro=='cpf' %}selected{% endif %}>CPF</option>
                <option value="id" {% if filtro=='id' %}selected{% endif %}>ID</option>
            </select>
        </label>

        <input name="valor" placeholder="valor" value="{{ valor }}">
        <button class="btn">Buscar</button>
    </form>

    <!-- Filtro por data -->
    <form method="GET" action="{{ url_for('table') }}" class="inline">
        <input type="hidden" name="office" value="{{ office }}">

        <label>Filtrar data:
            <select name="data_tipo">
                <option value="">--</option>
                <option value="data_fechamento" {% if data_tipo=='data_fechamento' %}selected{% endif %}>Fechamento</option>
                <option value="data_protocolo" {% if data_tipo=='data_protocolo' %}selected{% endif %}>Protocolo</option>
            </select>
        </label>

        <label>De:
            <input type="date" name="data_de" value="{{ data_de }}">
        </label>

        <label>Até:
            <input type="date" name="data_ate" value="{{ data_ate }}">
        </label>

        <button class="btn">Filtrar</button>
    </form>

</div>

<!-- Ações gerais -->
<div class="toolbar">

    <form id="deleteSelectedForm" method="POST" action="{{ url_for('delete_selected') }}" class="inline">
        <input type="hidden" name="office" value="{{ office }}">
        <button class="btn-danger" type="submit" onclick="return confirm('Excluir selecionados?')">Excluir selecionados</button>
    </form>

    <form id="migrateSelectedForm" method="POST" action="{{ url_for('migrate_selected') }}" class="inline">
        <input type="hidden" name="office_current" value="{{ office }}">

        <label>Mover selecionados para:
            <select name="office_target">
                {% for o in offices %}
                    {% if o.key != office %}
                        <option value="{{ o.key }}">{{ o.display }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </label>

        <button class="btn" type="submit" onclick="return confirm('Mover registros selecionados?')">Mover</button>
    </form>

    <a class="btn" href="{{ url_for('export_csv', office=office) }}">Exportar CSV</a>
    <a class="btn" href="{{ url_for('export_pdf', office=office) }}">Exportar PDF</a>

</div>

<!-- Tabela -->
<div class="card scrollable">
<table class="table">
    <thead>
        <tr>
            <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
            <th>ID</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Escritório</th>
            <th>Tipo</th>
            <th>Fechamento</th>
            <th>Ações</th>
        </tr>
    </thead>

    <tbody>
    {% for r in rows %}
        <tr>
            <td>
                <input type="checkbox" name="ids" form="deleteSelectedForm" value="{{ r[0] }}">
                <input type="hidden" name="ids" form="migrateSelectedForm" value="{{ r[0] }}">
            </td>

            <td>{{ r[0] }}</td>
            <td>{{ r[1] }}</td>
            <td>{{ r[2] }}</td>
            <td>{{ r[3] }}</td>
            <td>{{ r[5] }}</td>
            <td>{{ r[6] }}</td>

            <td>

                <!-- EDIT -->
                <a class="btn-small" href="{{ url_for('edit', id=r[0], office=office) }}">Editar</a>

                <!-- DELETE individual -->
                <form method="POST" action="{{ url_for('delete') }}" class="inline">
                    <input type="hidden" name="id" value="{{ r[0] }}">
                    <input type="hidden" name="office" value="{{ office }}">
                    <button class="btn-small-danger" onclick="return confirm('Excluir este registro?')">Excluir</button>
                </form>

                <!-- MIGRAR individual -->
                <form method="POST" action="{{ url_for('migrate') }}" class="inline">
                    <input type="hidden" name="id" value="{{ r[0] }}">
                    <input type="hidden" name="office_current" value="{{ office }}">

                    <select name="office_target" class="mini-select">
                        {% for o in offices %}
                            {% if o.key != office %}
                                <option value="{{ o.key }}">{{ o.display }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>

                    <button class="btn-small" onclick="return confirm('Mover este registro?')">Mover</button>
                </form>

            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

<!-- Paginação -->
<div class="pagination">
    {% if page > 1 %}
        <a href="{{ url_for('table', office=office, page=1, per_page=per_page) }}">&laquo; Primeiro</a>
        <a href="{{ url_for('table', office=office, page=page-1, per_page=per_page) }}">Anterior</a>
    {% endif %}

    <span>Página {{ page }} de {{ total_pages }}</span>

    {% if page < total_pages %}
        <a href="{{ url_for('table', office=office, page=page+1, per_page=per_page) }}">Próxima</a>
        <a href="{{ url_for('table', office=office, page=total_pages, per_page=per_page) }}">Última &raquo;</a>
    {% endif %}
</div>

{% endblock %}
