{% extends "base.html" %}
{% block content %}

<h1>Registros – Escritório {{ office }}</h1>

<div class="filters">

  <!-- Seleção de escritório -->
  <form method="get" action="{{ url_for('table') }}" class="inline-form">
    <label>Escritório:
      <select name="office" onchange="this.form.submit()">
        {% for o in offices %}
          <option value="{{ o }}" {% if o == office %}selected{% endif %}>{{ o }}</option>
        {% endfor %}
      </select>
    </label>
  </form>

  <!-- Busca -->
  <form method="get" action="{{ url_for('table') }}" class="inline-form">
    <input type="hidden" name="office" value="{{ office }}">
    <label>Buscar por:
      <select name="filtro">
        <option value="">Nenhum</option>
        <option value="nome" {% if filtro == 'nome' %}selected{% endif %}>Nome</option>
        <option value="cpf" {% if filtro == 'cpf' %}selected{% endif %}>CPF</option>
        <option value="id" {% if filtro == 'id' %}selected{% endif %}>ID</option>
      </select>
    </label>

    <input name="valor" placeholder="Digite o valor" value="{{ valor }}">
    <button class="btn-small" type="submit">Buscar</button>
  </form>

  <!-- Filtros de data -->
  <form method="get" action="{{ url_for('table') }}" class="inline-form">
    <input type="hidden" name="office" value="{{ office }}">
    <label>
      Filtrar por:
      <select name="data_tipo">
        <option value="">Nenhum</option>
        <option value="data_fechamento" {% if data_tipo=='data_fechamento' %}selected{% endif %}>Data de fechamento</option>
        <option value="data_protocolo" {% if data_tipo=='data_protocolo' %}selected{% endif %}>Data de protocolo</option>
      </select>
    </label>

    <label>De <input type="date" name="data_de" value="{{ data_de }}"></label>
    <label>Até <input type="date" name="data_ate" value="{{ data_ate }}"></label>

    <button class="btn-small" type="submit">Filtrar</button>
  </form>

</div>

<!-- Migração em lote -->
<form method="post" action="{{ url_for('migrate_selected') }}" id="migrateForm">
  <input type="hidden" name="office_current" value="{{ office }}">

  <label>Mover selecionados para:
    <select name="office_target" required>
      <option value="">Selecione...</option>
      {% for o in offices %}
        {% if o != office %}
          <option value="{{ o }}">{{ o }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </label>
  <button class="btn-small" type="submit">Mover</button>
</form>


<table>
  <tr>
    <th><input type="checkbox" id="select-all"></th>
    <th>ID</th>
    <th>Nome</th>
    <th>CPF</th>
    <th>Ação</th>
    <th>Ações</th>
  </tr>

  {% for r in rows %}
  <tr>
    <td><input type="checkbox" class="row-select" value="{{ r[0] }}"></td>
    <td>{{ r[0] }}</td>
    <td>{{ r[1] }}</td>
    <td>{{ r[2] }}</td>
    <td>{{ r[4] }}</td>

    <td>
      <form action="{{ url_for('delete') }}" method="post" onsubmit="return confirm('Excluir?')">
        <input type="hidden" name="id" value="{{ r[0] }}">
        <input type="hidden" name="office" value="{{ office }}">
        <button class="btn-small danger">Excluir</button>
      </form>

      <a class="btn-small" href="{{ url_for('edit', id=r[0], office=office) }}">Editar</a>

      <form action="{{ url_for('migrate') }}" method="post" class="inline-form">
        <input type="hidden" name="id" value="{{ r[0] }}">
        <input type="hidden" name="office_current" value="{{ office }}">
        <select name="office_target">
          {% for o in offices %}
            {% if o != office %}
              <option value="{{ o }}">{{ o }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <button class="btn-small">Mover</button>
      </form>

    </td>
  </tr>
  {% endfor %}
</table>


<!-- Excluir selecionados -->
<form method="post" action="{{ url_for('delete_selected') }}" id="deleteSelectedForm">
  <input type="hidden" name="office" value="{{ office }}">
  <button class="btn-small danger">Excluir selecionados</button>
</form>

<!-- Paginação -->
<div class="pagination">
  {% if page > 1 %}
    <a href="{{ url_for('table', office=office, page=page-1, per_page=per_page) }}">« Anterior</a>
  {% endif %}

  Página {{ page }} de {{ total_pages }}

  {% if page < total_pages %}
    <a href="{{ url_for('table', office=office, page=page+1, per_page=per_page) }}">Próxima »</a>
  {% endif %}
</div>

{% endblock %}
